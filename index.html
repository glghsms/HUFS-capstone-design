<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì¹´í…Œê³ ë¦¬ ë„¤ë¹„ê²Œì´ì…˜</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css">
    <style>
      .category-table {
          border-collapse: collapse;
          width: 100%;
          margin-bottom: 20px;
          table-layout: fixed;
      }
      .category-table th, .category-table td {
          border: 1px solid #ddd;
          padding: 8px;
          text-align: left;
          vertical-align: top;
          white-space: nowrap;
          overflow: hidden;
          text-overflow: ellipsis;
      }
      .category-table th {
          background-color: #f2f2f2;
          font-size: 14px;
      }
      .hidden-rows {
          visibility: hidden;
          opacity: 0;
      }

      .hidden-rows td {
          color: transparent;      
          border-color: transparent; 
      }
      .show {
          visibility: visible;
          opacity: 1;
      }

      .show td {
          color: #000;
          border-color: #ddd;
      }
      .ranking-table {
            width: 100%;
            margin-top: 20px;
            border-collapse: collapse;
        }

        .ranking-table th, .ranking-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }

        .ranking-table th {
            background-color: #f2f2f2;
        }

  </style>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ì¹´í…Œê³ ë¦¬ ë„¤ë¹„ê²Œì´ì…˜ (ë²„íŠ¼í˜•)</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css">
  <style>
    html, body {
      height: 100%;
      overflow-x: hidden;
    }
    .selected {
      background-color: #60a5fa !important;
      color: white !important;
    }
    .category-table button {
      width: 100%;
      text-align: left;
    }
    #category-details {
      overflow: hidden;
      transition: max-height 0.6s ease;
    }
    #category-details.collapsed {
      max-height: 60px;
    }
    #category-details.expanded {
      max-height: 3000px;
    }
  </style>
</head>
<!-- ìƒë‹¨ í—¤ë” -->
<div class="w-full bg-white shadow flex justify-between items-center px-6 py-2 fixed top-0 z-50" style="height: 50px;">
    <h1 class="text-lg font-bold text-center w-full absolute left-1/2 transform -translate-x-1/2">
      ì €ì¶œì‚° ì •ì±… ê°€ì´ë“œ
    </h1>
    <button id="chatbot-button" class="rounded-full bg-blue-500 text-white p-3 hover:bg-blue-600 transition duration-300 ml-auto z-50">
      ğŸ’¬
    </button>
  </div>
  
  <!-- ëŒ€ë¶„ë¥˜ ì…€ê³¼ ê²¹ì¹˜ì§€ ì•Šë„ë¡ ì—¬ë°± ì¶”ê°€ -->
  <div style="margin-top: 60px;"></div>
  
  <!-- ì±—ë´‡ ì°½ -->
  <div id="chatbot-window" class="fixed bottom-20 right-6 w-80 h-96 bg-white shadow-xl border border-gray-300 rounded-xl p-4 hidden z-50 transition-all">
    <div class="flex justify-between items-center mb-2">
      <h2 class="text-base font-semibold">ì •ì±… ìƒë‹´ ì±—ë´‡</h2>
      <button id="close-chatbot" class="text-gray-500 hover:text-gray-800">âœ–</button>
    </div>
    <div class="h-64 overflow-y-auto border p-2 rounded text-sm text-gray-700 bg-gray-50">
      <p>ì•ˆë…•í•˜ì„¸ìš”! ê¶ê¸ˆí•œ ì •ì±…ì„ ì…ë ¥í•´ ì£¼ì„¸ìš” ğŸ˜Š</p>
      <!-- ì—¬ê¸° ì±„íŒ… ë‚´ìš© ë“¤ì–´ê° -->
    </div>
    <input type="text" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." class="w-full mt-2 p-2 border rounded text-sm focus:outline-none">
  </div>
  
<body class="bg-gray-100 min-h-screen">
  <div class="container mx-auto py-8">
    <div id="category-details" class="mt-4 collapsed"></div>

    <div class="grid grid-cols-2 gap-4 mt-8">
      <div class="bg-white shadow rounded p-4">
        <h2 class="text-lg font-bold mb-2">ê¸ì • ë¹„ìœ¨ ìˆœìœ„</h2>
        <ol id="positive-ranking" class="list-decimal pl-5 text-sm space-y-1"></ol>
      </div>
      <div class="bg-white shadow rounded p-4">
        <h2 class="text-lg font-bold mb-2">ë¹ˆë„ ìˆœìœ„</h2>
        <ol id="frequency-ranking" class="list-decimal pl-5 text-sm space-y-1"></ol>
      </div>
    </div>
  </div>

  <script>
    const categoryMapping = {
      "ê²°í˜¼": {
        "ë¹„ìš©": ["í˜¼ì¸ì¦ì—¬ì„¸", "ì¶œì‚°ì¦ì—¬ì„¸"],
        "ì£¼ê±°": ["ì‹ í˜¼ë¶€ë¶€ì£¼íƒê³µê¸‰", "ì‹ í˜¼ë¶€ë¶€ì£¼íƒëŒ€ì¶œ"]
      },
      "ì„ì‹ ": {
        "ê±´ê°•ë¹„ìš©": ["ë‚œì„ì‹œìˆ ë¹„ì§€ì›", "ëƒ‰ë™ë‚œì", "ì„ì‹ ê¸°ê·¼ë¡œë‹¨ì¶•", "í•„ìˆ˜ê°€ì„ë ¥ê²€ì‚¬ë¹„ìš©ì§€ì›", "ë‚œì„ì¹˜ë£Œíœ´ê°€", "ì„ì‹ ì¶œì‚°ì§„ë£Œë¹„ë°”ìš°ì²˜"]
      },
      "ì¶œì‚°": {
        "ë¹„ìš©": ["ìë…€ì„¸ì•¡ê³µì œ", "ì²«ë§Œë‚¨ì´ìš©ê¶Œ", "ì‚°í›„ì¡°ë¦¬ë¹„ìš©ì„¸ì•¡ê³µì œ"],
        "ì£¼ê±°": ["ì‹ ìƒì•„ì¶œì‚°ê°€êµ¬ì£¼íƒëŒ€ì¶œ", "ì¶œì‚°ê°€êµ¬ì£¼íƒê³µê¸‰"],
        "ê±´ê°•": ["ì‹ ìƒì•„ì‚°ëª¨ê±´ê°•ê´€ë¦¬", "ë°°ìš°ìì¶œì‚°íœ´ê°€", "ì¶œì‚°ì „í›„íœ´ê°€"],
        "ëŒë´„": ["ì‚°í›„ì¡°ë¦¬ë„ìš°ë¯¸ì§€ì›"]
      },

      "ì˜ìœ ì•„": {
        "ë¹„ìš©": ["ì•„ë™ìˆ˜ë‹¹", "ìë…€ì¥ë ¤ê¸ˆí™•ëŒ€", "ë¶€ëª¨ê¸‰ì—¬", "ë””ë”¤ì”¨ì•—í†µì¥"],
        "ëŒë´„": ["ê°€ì •ì–‘ìœ¡ìˆ˜ë‹¹", "ì‹œê°„ì œë³´ìœ¡", "ìœ¡ì•„ê¸°ê·¼ë¡œì‹œê°„ë‹¨ì¶•", "ì•„ì´ëŒë´„ì„œë¹„ìŠ¤", "ê°€ì¡±ëŒë´„íœ´ê°€", "ìœ ë³´í†µí•©", "ìœ¡ì•„íœ´ì§"],
        "ì£¼ê±°": ["ë‹¤ìë…€íŠ¹ë³„ê³µê¸‰", "ê³µê³µë¶„ì–‘ì„ëŒ€ì†Œë“ìì‚°ìš”ê±´ì™„í™”"]
      },
      "ì´ˆë“±": {
        "ëŒë´„": ["ì´ˆë“±ëŠ˜ë´„í•™êµ"],
        "ë¹„ìš©": ["ì´ˆë“±ìë…€ì„¸ì•¡ê³µì œ", "ë‹¤ìë…€ê°€êµ¬ì´ˆì¤‘ê³ êµìœ¡ë¹„ì§€ì›í™•ëŒ€"]
      }
    };

    const categoryDetails = document.getElementById('category-details');
    const positiveRankingList = document.getElementById('positive-ranking');
    const frequencyRankingList = document.getElementById('frequency-ranking');

    function expandTable() {
      categoryDetails.classList.remove('collapsed');
      categoryDetails.classList.add('expanded');
    }

    function collapseTable() {
      categoryDetails.classList.remove('expanded');
      categoryDetails.classList.add('collapsed');
    }

    function createButton(text, onClick, isLeaf = false) {
      const btn = document.createElement('button');
      btn.textContent = text;
      btn.className = 'p-2 border border-gray-300 rounded hover:bg-blue-100 w-full';
      btn.dataset.isLeaf = isLeaf;
      btn.onclick = () => {
        const isSelected = btn.classList.toggle('selected');
        onClick(isSelected);
        fetchEmotionSummary();
        updateRankings();
      };
      return btn;
    }

    let emotionData = {}; // ì„œë²„ì—ì„œ ê°€ì ¸ì˜¨ ë°ì´í„°ë¥¼ ì €ì¥í•  ë³€ìˆ˜

    function fetchEmotionSummary() {
      const selectedLeafs = Array.from(document.querySelectorAll('button.selected[data-is-leaf="true"]'))
       .map(btn => btn.textContent);

      fetch('http://localhost:5001/api/emotion-summary', {
       method: 'POST',
       headers: {
         'Content-Type': 'application/json'
    },
       body: JSON.stringify({ selected: selectedLeafs }) // âœ… selected í•­ëª© ì¶”ê°€
  })
       .then(response => response.json())
       .then(data => {
         emotionData = data;
         updateRankings(); // ë°›ì•„ì˜¨ ë°ì´í„°ë¡œ ìˆœìœ„ ë‹¤ì‹œ ê·¸ë¦¬ê¸°
    })
       .catch(error => {
         console.error("Error fetching emotion summary:", error);
    });
}



    // ê¸ì • ë¹„ìœ¨ì„ API ë°ì´í„°ì—ì„œ ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜
    function getPositiveRate(item) {
      const categoryData = emotionData[item];
      if (!categoryData) return 0; // ë°ì´í„°ê°€ ì—†ìœ¼ë©´ 0 ë°˜í™˜

      const total = categoryData.positive + categoryData.negative + categoryData.neutral;
      return total ? categoryData.positive / total : 0; // ê¸ì • ë¹„ìœ¨ ê³„ì‚°
    }

    // ë¹ˆë„ìœ¨ì„ API ë°ì´í„°ì—ì„œ ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜
    function getFrequencyRate(item) {
      const categoryData = emotionData[item];
      if (!categoryData) return 0; // ë°ì´í„°ê°€ ì—†ìœ¼ë©´ 0 ë°˜í™˜

      return categoryData.positive + categoryData.negative + categoryData.neutral; // ë¹ˆë„ ê³„ì‚°
    }

    function updateRankings() {
    const selectedLeafs = Array.from(document.querySelectorAll('button.selected[data-is-leaf="true"]'))
      .map(btn => btn.textContent);

    const rankedPositive = selectedLeafs
      .map(text => ({ text, score: getPositiveRate(text) }))
      .sort((a, b) => b.score - a.score);

    const rankedFreq = selectedLeafs
      .map(text => ({ text, score: getFrequencyRate(text) }))
      .sort((a, b) => b.score - a.score);

    // ì „ì²´ ê¸ì • ìˆœìœ„ ê³„ì‚°ì„ ìœ„í•œ ì •ë ¬
    const allCategories = Object.keys(emotionData);
    const allPositiveRank = allCategories
      .map(text => ({ text, score: getPositiveRate(text) }))
      .sort((a, b) => b.score - a.score);

    const positiveRankMap = {};
    allPositiveRank.forEach((item, idx) => {
      positiveRankMap[item.text] = idx + 1; // ì „ì²´ ìˆœìœ„ ë§¤í•‘
    });

    // ê¸ì • ë¹„ìœ¨ ìˆœìœ„ ì—…ë°ì´íŠ¸
    positiveRankingList.innerHTML = '';
    rankedPositive.forEach(item => {
      const li = document.createElement('li');
      const overallRank = positiveRankMap[item.text] || '-';
      li.textContent = `${item.text} (ì „ì²´ ${overallRank}ìœ„)`;
      positiveRankingList.appendChild(li);
    });

    // ë¹ˆë„ ìˆœìœ„ ì—…ë°ì´íŠ¸
    frequencyRankingList.innerHTML = '';
    rankedFreq.forEach(item => {
      const li = document.createElement('li');
      li.textContent = `${item.text} (${item.score})`;
      frequencyRankingList.appendChild(li);
    });
  }

    // í˜ì´ì§€ê°€ ë¡œë“œë˜ë©´ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜ í˜¸ì¶œ
    window.onload = fetchEmotionSummary;



    function createCategoryTable() {
      const table = document.createElement('table');
      table.classList.add('category-table', 'table-fixed', 'w-full');

      const thead = document.createElement('thead');
      const headerRow = document.createElement('tr');

      const blankTh = document.createElement('th');
      headerRow.appendChild(blankTh);

      Object.keys(categoryMapping).forEach(mainCategory => {
        const th = document.createElement('th');
        const mainBtn = createButton(mainCategory, (selecting) => {
          Object.keys(categoryMapping[mainCategory]).forEach(sub => {
            categoryMapping[mainCategory][sub].forEach(value => {
              const el = document.querySelector(`button[data-main='${mainCategory}'][data-sub='${sub}'][data-value='${value}']`);
              if (el) el.classList.toggle('selected', selecting);
            });
          });
        }, false);
        mainBtn.onmouseenter = expandTable;
        th.appendChild(mainBtn);
        headerRow.appendChild(th);
      });

      thead.appendChild(headerRow);
      table.appendChild(thead);

      const tbody = document.createElement('tbody');
      table.appendChild(tbody);

      const allSubCategories = new Set();
      Object.values(categoryMapping).forEach(subCategoryMap => {
        Object.keys(subCategoryMap).forEach(subCategory => {
          allSubCategories.add(subCategory);
        });
      });

      allSubCategories.forEach(subCategory => {
        const maxRows = Math.max(...Object.values(categoryMapping).map(subCategoryMap => (subCategoryMap[subCategory] || []).length));

        for (let i = 0; i < maxRows; i++) {
          const row = document.createElement('tr');

          if (i === 0) {
            const subCategoryTd = document.createElement('td');
            const subBtn = createButton(subCategory, (selecting) => {
              document.querySelectorAll(`button[data-sub='${subCategory}'][data-is-leaf='true']`).forEach(el => {
                el.classList.toggle('selected', selecting);
              });
            }, false);
            subCategoryTd.rowSpan = maxRows;
            subCategoryTd.appendChild(subBtn);
            row.appendChild(subCategoryTd);
          }

          Object.keys(categoryMapping).forEach(mainCategory => {
            const cell = document.createElement('td');
            const items = categoryMapping[mainCategory][subCategory] || [];
            const value = items[i];
            if (value) {
              const btn = createButton(value, () => {}, true);
              btn.setAttribute('data-main', mainCategory);
              btn.setAttribute('data-sub', subCategory);
              btn.setAttribute('data-value', value);
              cell.appendChild(btn);
            }
            row.appendChild(cell);
          });

          tbody.appendChild(row);
        }
      });

      return table;
    }

    categoryDetails.appendChild(createCategoryTable());
    categoryDetails.onmouseleave = collapseTable;
    const chatButton = document.getElementById('chatbot-button');
    const chatbotWindow = document.getElementById('chatbot-window');
    const closeChatbot = document.getElementById('close-chatbot');

    chatButton.addEventListener('click', () => {
        chatbotWindow.classList.toggle('hidden');
    });

    closeChatbot.addEventListener('click', () => {
        chatbotWindow.classList.add('hidden');
    });

  </script>
</body>
</html>
