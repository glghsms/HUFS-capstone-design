<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>카테고리 네비게이션</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css">
    <style>
      .category-table {
          border-collapse: collapse;
          width: 100%;
          margin-bottom: 20px;
          table-layout: fixed;
      }
      .category-table th, .category-table td {
          border: 1px solid #ddd;
          padding: 8px;
          text-align: left;
          vertical-align: top;
          white-space: nowrap;
          overflow: hidden;
          text-overflow: ellipsis;
      }
      .category-table th {
          background-color: #f2f2f2;
          font-size: 14px;
      }
      .hidden-rows {
          visibility: hidden;
          opacity: 0;
      }

      .hidden-rows td {
          color: transparent;      
          border-color: transparent; 
      }
      .show {
          visibility: visible;
          opacity: 1;
      }

      .show td {
          color: #000;
          border-color: #ddd;
      }
      .ranking-table {
            width: 100%;
            margin-top: 20px;
            border-collapse: collapse;
        }

        .ranking-table th, .ranking-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }

        .ranking-table th {
            background-color: #f2f2f2;
        }

  </style>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>카테고리 네비게이션 (버튼형)</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css">
  <style>
    html, body {
      height: 100%;
      overflow-x: hidden;
    }
    .selected {
      background-color: #60a5fa !important;
      color: white !important;
    }
    .category-table button {
      width: 100%;
      text-align: left;
    }
    #category-details {
      overflow: hidden;
      transition: max-height 0.6s ease;
    }
    #category-details.collapsed {
      max-height: 60px;
    }
    #category-details.expanded {
      max-height: 3000px;
    }
  </style>
</head>
<!-- 상단 헤더 -->
<div class="w-full bg-white shadow flex justify-between items-center px-6 py-2 fixed top-0 z-50" style="height: 50px;">
    <h1 class="text-lg font-bold text-center w-full absolute left-1/2 transform -translate-x-1/2">
      저출산 정책 가이드
    </h1>
    <button id="chatbot-button" class="rounded-full bg-blue-500 text-white p-3 hover:bg-blue-600 transition duration-300 ml-auto z-50">
      💬
    </button>
  </div>
  
  <!-- 대분류 셀과 겹치지 않도록 여백 추가 -->
  <div style="margin-top: 60px;"></div>
  
  <!-- 챗봇 창 -->
  <div id="chatbot-window" class="fixed bottom-20 right-6 w-80 h-96 bg-white shadow-xl border border-gray-300 rounded-xl p-4 hidden z-50 transition-all">
    <div class="flex justify-between items-center mb-2">
      <h2 class="text-base font-semibold">정책 상담 챗봇</h2>
      <button id="close-chatbot" class="text-gray-500 hover:text-gray-800">✖</button>
    </div>
    <div class="h-64 overflow-y-auto border p-2 rounded text-sm text-gray-700 bg-gray-50">
      <p>안녕하세요! 궁금한 정책을 입력해 주세요 😊</p>
      <!-- 여기 채팅 내용 들어감 -->
    </div>
    <input type="text" placeholder="메시지를 입력하세요..." class="w-full mt-2 p-2 border rounded text-sm focus:outline-none">
  </div>
  
<body class="bg-gray-100 min-h-screen">
  <div class="container mx-auto py-8">
    <div id="category-details" class="mt-4 collapsed"></div>

    <div class="grid grid-cols-2 gap-4 mt-8">
      <div class="bg-white shadow rounded p-4">
        <h2 class="text-lg font-bold mb-2">긍정 비율 순위</h2>
        <ol id="positive-ranking" class="list-decimal pl-5 text-sm space-y-1"></ol>
      </div>
      <div class="bg-white shadow rounded p-4">
        <h2 class="text-lg font-bold mb-2">빈도 순위</h2>
        <ol id="frequency-ranking" class="list-decimal pl-5 text-sm space-y-1"></ol>
      </div>
    </div>
  </div>

  <script>
    const categoryMapping = {
      "결혼": {
        "비용": ["혼인증여세", "출산증여세"],
        "주거": ["신혼부부주택공급", "신혼부부주택대출"]
      },
      "임신": {
        "건강비용": ["난임시술비지원", "냉동난자", "임신기근로단축", "필수가임력검사비용지원", "난임치료휴가", "임신출산진료비바우처"]
      },
      "출산": {
        "비용": ["자녀세액공제", "첫만남이용권", "산후조리비용세액공제"],
        "주거": ["신생아출산가구주택대출", "출산가구주택공급"],
        "건강": ["신생아산모건강관리", "배우자출산휴가", "출산전후휴가"],
        "돌봄": ["산후조리도우미지원"]
      },

      "영유아": {
        "비용": ["아동수당", "자녀장려금확대", "부모급여", "디딤씨앗통장"],
        "돌봄": ["가정양육수당", "시간제보육", "육아기근로시간단축", "아이돌봄서비스", "가족돌봄휴가", "유보통합", "육아휴직"],
        "주거": ["다자녀특별공급", "공공분양임대소득자산요건완화"]
      },
      "초등": {
        "돌봄": ["초등늘봄학교"],
        "비용": ["초등자녀세액공제", "다자녀가구초중고교육비지원확대"]
      }
    };

    const categoryDetails = document.getElementById('category-details');
    const positiveRankingList = document.getElementById('positive-ranking');
    const frequencyRankingList = document.getElementById('frequency-ranking');

    function expandTable() {
      categoryDetails.classList.remove('collapsed');
      categoryDetails.classList.add('expanded');
    }

    function collapseTable() {
      categoryDetails.classList.remove('expanded');
      categoryDetails.classList.add('collapsed');
    }

    function createButton(text, onClick, isLeaf = false) {
      const btn = document.createElement('button');
      btn.textContent = text;
      btn.className = 'p-2 border border-gray-300 rounded hover:bg-blue-100 w-full';
      btn.dataset.isLeaf = isLeaf;
      btn.onclick = () => {
        const isSelected = btn.classList.toggle('selected');
        onClick(isSelected);
        fetchEmotionSummary();
        updateRankings();
      };
      return btn;
    }

    let emotionData = {}; // 서버에서 가져온 데이터를 저장할 변수

    function fetchEmotionSummary() {
      const selectedLeafs = Array.from(document.querySelectorAll('button.selected[data-is-leaf="true"]'))
       .map(btn => btn.textContent);

      fetch('http://localhost:5001/api/emotion-summary', {
       method: 'POST',
       headers: {
         'Content-Type': 'application/json'
    },
       body: JSON.stringify({ selected: selectedLeafs }) // ✅ selected 항목 추가
  })
       .then(response => response.json())
       .then(data => {
         emotionData = data;
         updateRankings(); // 받아온 데이터로 순위 다시 그리기
    })
       .catch(error => {
         console.error("Error fetching emotion summary:", error);
    });
}



    // 긍정 비율을 API 데이터에서 가져오는 함수
    function getPositiveRate(item) {
      const categoryData = emotionData[item];
      if (!categoryData) return 0; // 데이터가 없으면 0 반환

      const total = categoryData.positive + categoryData.negative + categoryData.neutral;
      return total ? categoryData.positive / total : 0; // 긍정 비율 계산
    }

    // 빈도율을 API 데이터에서 가져오는 함수
    function getFrequencyRate(item) {
      const categoryData = emotionData[item];
      if (!categoryData) return 0; // 데이터가 없으면 0 반환

      return categoryData.positive + categoryData.negative + categoryData.neutral; // 빈도 계산
    }

    function updateRankings() {
    const selectedLeafs = Array.from(document.querySelectorAll('button.selected[data-is-leaf="true"]'))
      .map(btn => btn.textContent);

    const rankedPositive = selectedLeafs
      .map(text => ({ text, score: getPositiveRate(text) }))
      .sort((a, b) => b.score - a.score);

    const rankedFreq = selectedLeafs
      .map(text => ({ text, score: getFrequencyRate(text) }))
      .sort((a, b) => b.score - a.score);

    // 전체 긍정 순위 계산을 위한 정렬
    const allCategories = Object.keys(emotionData);
    const allPositiveRank = allCategories
      .map(text => ({ text, score: getPositiveRate(text) }))
      .sort((a, b) => b.score - a.score);

    const positiveRankMap = {};
    allPositiveRank.forEach((item, idx) => {
      positiveRankMap[item.text] = idx + 1; // 전체 순위 매핑
    });

    // 긍정 비율 순위 업데이트
    positiveRankingList.innerHTML = '';
    rankedPositive.forEach(item => {
      const li = document.createElement('li');
      const overallRank = positiveRankMap[item.text] || '-';
      li.textContent = `${item.text} (전체 ${overallRank}위)`;
      positiveRankingList.appendChild(li);
    });

    // 빈도 순위 업데이트
    frequencyRankingList.innerHTML = '';
    rankedFreq.forEach(item => {
      const li = document.createElement('li');
      li.textContent = `${item.text} (${item.score})`;
      frequencyRankingList.appendChild(li);
    });
  }

    // 페이지가 로드되면 데이터를 가져오는 함수 호출
    window.onload = fetchEmotionSummary;



    function createCategoryTable() {
      const table = document.createElement('table');
      table.classList.add('category-table', 'table-fixed', 'w-full');

      const thead = document.createElement('thead');
      const headerRow = document.createElement('tr');

      const blankTh = document.createElement('th');
      headerRow.appendChild(blankTh);

      Object.keys(categoryMapping).forEach(mainCategory => {
        const th = document.createElement('th');
        const mainBtn = createButton(mainCategory, (selecting) => {
          Object.keys(categoryMapping[mainCategory]).forEach(sub => {
            categoryMapping[mainCategory][sub].forEach(value => {
              const el = document.querySelector(`button[data-main='${mainCategory}'][data-sub='${sub}'][data-value='${value}']`);
              if (el) el.classList.toggle('selected', selecting);
            });
          });
        }, false);
        mainBtn.onmouseenter = expandTable;
        th.appendChild(mainBtn);
        headerRow.appendChild(th);
      });

      thead.appendChild(headerRow);
      table.appendChild(thead);

      const tbody = document.createElement('tbody');
      table.appendChild(tbody);

      const allSubCategories = new Set();
      Object.values(categoryMapping).forEach(subCategoryMap => {
        Object.keys(subCategoryMap).forEach(subCategory => {
          allSubCategories.add(subCategory);
        });
      });

      allSubCategories.forEach(subCategory => {
        const maxRows = Math.max(...Object.values(categoryMapping).map(subCategoryMap => (subCategoryMap[subCategory] || []).length));

        for (let i = 0; i < maxRows; i++) {
          const row = document.createElement('tr');

          if (i === 0) {
            const subCategoryTd = document.createElement('td');
            const subBtn = createButton(subCategory, (selecting) => {
              document.querySelectorAll(`button[data-sub='${subCategory}'][data-is-leaf='true']`).forEach(el => {
                el.classList.toggle('selected', selecting);
              });
            }, false);
            subCategoryTd.rowSpan = maxRows;
            subCategoryTd.appendChild(subBtn);
            row.appendChild(subCategoryTd);
          }

          Object.keys(categoryMapping).forEach(mainCategory => {
            const cell = document.createElement('td');
            const items = categoryMapping[mainCategory][subCategory] || [];
            const value = items[i];
            if (value) {
              const btn = createButton(value, () => {}, true);
              btn.setAttribute('data-main', mainCategory);
              btn.setAttribute('data-sub', subCategory);
              btn.setAttribute('data-value', value);
              cell.appendChild(btn);
            }
            row.appendChild(cell);
          });

          tbody.appendChild(row);
        }
      });

      return table;
    }

    categoryDetails.appendChild(createCategoryTable());
    categoryDetails.onmouseleave = collapseTable;
    const chatButton = document.getElementById('chatbot-button');
    const chatbotWindow = document.getElementById('chatbot-window');
    const closeChatbot = document.getElementById('close-chatbot');

    chatButton.addEventListener('click', () => {
        chatbotWindow.classList.toggle('hidden');
    });

    closeChatbot.addEventListener('click', () => {
        chatbotWindow.classList.add('hidden');
    });

  </script>
</body>
</html>
